language: node_js
node_js:
  - "8"
dist: xenial

sudo: false

branches:
  only:
    - master

addons:
  apt:
    sources:
      - google-chrome
    packages:
      - google-chrome-stable

before_install:
  - npm install -g @angular/cli

install:
  - npm install

jobs:
  include:
    - stage: test
      script: npm run $COMMAND
      name: Test
      env: COMMAND="test -- --watch=false --no-progress --browsers=ChromeHeadlessNoSandbox"

    - script: npm run $COMMAND
      name: Lint
      install: skip
      env: COMMAND=lint

    - stage: build
      script:
        - ng build $BUILD
        - mv dist/angular-ssr/index.html dist/angular-ssr/404.html
      name: Build
      env: BUILD="--prod --base-href /angular-ssr/"
      deploy:
        provider: pages
        skip_cleanup: true
        github_token: "$GITHUB_TOKEN"
        local_dir: dist/angular-ssr/
        on:
          branch: master
          # all_branches: true
          # condition: "$TRAVIS_BRANCH =~ ^master|ANSSR-2$"
cache:
  directories:
    - node_modules

